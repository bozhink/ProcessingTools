!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("../fold/xml-fold")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],e):e(CodeMirror)}(function(b){b.defineOption("autoCloseTags",!1,function(e,t,n){if(n!=b.Init&&n&&e.removeKeyMap("autoCloseTags"),t){var o={name:"autoCloseTags"};("object"!=typeof t||t.whenClosing)&&(o["'/'"]=function(e){return(t=e).getOption("disableInput")?b.Pass:a(t,!0);var t}),("object"!=typeof t||t.whenOpening)&&(o["'>'"]=function(e){return function(e){if(e.getOption("disableInput"))return b.Pass;for(var t=e.listSelections(),n=[],o=e.getOption("autoCloseTags"),a=0;a<t.length;a++){if(!t[a].empty())return b.Pass;var r=t[a].head,i=e.getTokenAt(r),s=b.innerMode(e.getMode(),i.state),l=s.state;if("xml"!=s.mode.name||!l.tagName)return b.Pass;var d="html"==s.mode.configuration,c="object"==typeof o&&o.dontCloseTags||d&&y,f="object"==typeof o&&o.indentTags||d&&x,g=l.tagName;i.end>r.ch&&(g=g.slice(0,g.length-i.end+r.ch));var u=g.toLowerCase();if(!g||"string"==i.type&&(i.end!=r.ch||!/[\"\']/.test(i.string.charAt(i.string.length-1))||1==i.string.length)||"tag"==i.type&&"closeTag"==l.type||i.string.indexOf("/")==i.string.length-1||c&&-1<P(c,u)||T(e,g,r,l,!0))return b.Pass;var m=f&&-1<P(f,u);n[a]={indent:m,text:">"+(m?"\n\n":"")+"</"+g+">",newPos:m?b.Pos(r.line+1,0):b.Pos(r.line,r.ch+1)}}for(var h="object"==typeof o&&o.dontIndentOnAutoClose,a=t.length-1;0<=a;a--){var p=n[a];e.replaceRange(p.text,t[a].head,t[a].anchor,"+insert");var v=e.listSelections().slice(0);v[a]={head:p.newPos,anchor:p.newPos},e.setSelections(v),!h&&p.indent&&(e.indentLine(p.newPos.line,null,!0),e.indentLine(p.newPos.line+1,null,!0))}}(e)}),e.addKeyMap(o)}});var y=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],x=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function a(e,t){for(var n=e.listSelections(),o=[],a=t?"/":"</",r=e.getOption("autoCloseTags"),i="object"==typeof r&&r.dontIndentOnSlash,s=0;s<n.length;s++){if(!n[s].empty())return b.Pass;var l,d=n[s].head,c=e.getTokenAt(d),f=b.innerMode(e.getMode(),c.state),g=f.state;if(t&&("string"==c.type||"<"!=c.string.charAt(0)||c.start!=d.ch-1))return b.Pass;if("xml"!=f.mode.name)if("htmlmixed"==e.getMode().name&&"javascript"==f.mode.name)l=a+"script";else{if("htmlmixed"!=e.getMode().name||"css"!=f.mode.name)return b.Pass;l=a+"style"}else{if(!g.context||!g.context.tagName||T(e,g.context.tagName,d,g))return b.Pass;l=a+g.context.tagName}">"!=e.getLine(d.line).charAt(c.end)&&(l+=">"),o[s]=l}if(e.replaceSelections(o),n=e.listSelections(),!i)for(s=0;s<n.length;s++)(s==n.length-1||n[s].head.line<n[s+1].head.line)&&e.indentLine(n[s].head.line)}function P(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,o=e.length;n<o;++n)if(e[n]==t)return n;return-1}function T(e,t,n,o,a){if(!b.scanForClosingTag)return!1;var r=Math.min(e.lastLine()+1,n.line+500),i=b.scanForClosingTag(e,n,null,r);if(!i||i.tag!=t)return!1;for(var s=o.context,l=a?1:0;s&&s.tagName==t;s=s.prev)++l;n=i.to;for(var d=1;d<l;d++){var c=b.scanForClosingTag(e,n,null,r);if(!c||c.tag!=t)return!1;n=c.to}return!0}b.commands.closeTag=function(e){return a(e)}});